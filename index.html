<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Signal Tap ‚Äî Live Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <style>
    /* ============ RESET & BASE ============ */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --bg-root: #0a0c10;
      --bg-main: #0f1115;
      --bg-card: #1a1d24;
      --bg-card-hover: #1f2330;
      --bg-sidebar: #12151b;
      --bg-header: #12151b;
      --bg-input: #252830;
      --border: #2a2d35;
      --border-light: #353840;
      --cyan: #22d3ee;
      --cyan-dim: rgba(34, 211, 238, 0.15);
      --cyan-glow: rgba(34, 211, 238, 0.3);
      --purple: #a78bfa;
      --purple-dim: rgba(167, 139, 250, 0.15);
      --green: #4ade80;
      --green-dim: rgba(74, 222, 128, 0.15);
      --yellow: #facc15;
      --yellow-dim: rgba(250, 204, 21, 0.15);
      --red: #f87171;
      --red-dim: rgba(248, 113, 113, 0.15);
      --blue: #60a5fa;
      --blue-dim: rgba(96, 165, 250, 0.15);
      --orange: #fb923c;
      --text-primary: #f1f5f9;
      --text-secondary: #94a3b8;
      --text-muted: #64748b;
      --text-dim: #475569;
      --font-sans: 'Plus Jakarta Sans', system-ui, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --radius: 10px;
      --radius-sm: 6px;
      --radius-lg: 14px;
    }

    html { font-size: 15px; }
    body {
      background: var(--bg-root);
      font-family: var(--font-sans);
      color: var(--text-primary);
      min-height: 100vh;
      overflow-x: hidden;
    }
    ::selection { background: var(--cyan); color: #000; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--border-light); }

    /* ============ LAYOUT ============ */
    .app {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 220px;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      position: fixed;
      top: 0; left: 0; bottom: 0;
      z-index: 100;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .sidebar-brand {
      padding: 20px 20px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .sidebar-brand svg { color: var(--cyan); flex-shrink: 0; }
    .sidebar-brand-text { display: flex; flex-direction: column; }
    .sidebar-brand-name { font-weight: 700; font-size: 16px; letter-spacing: -0.02em; }
    .sidebar-brand-sub { font-size: 11px; color: var(--text-muted); font-family: var(--font-mono); }

    .sidebar-nav { flex: 1; padding: 12px 10px; display: flex; flex-direction: column; gap: 2px; }
    .nav-item {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 14px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 13.5px;
      font-weight: 500;
      transition: all 0.15s;
      border: 1px solid transparent;
      position: relative;
    }
    .nav-item:hover { background: rgba(255,255,255,0.04); color: var(--text-primary); }
    .nav-item.active {
      background: var(--cyan-dim);
      color: var(--cyan);
      border-color: rgba(34, 211, 238, 0.1);
    }
    .nav-item.active::before {
      content: '';
      position: absolute;
      left: -10px;
      top: 50%;
      transform: translateY(-50%);
      width: 3px;
      height: 20px;
      background: var(--cyan);
      border-radius: 0 3px 3px 0;
    }
    .nav-item svg { width: 18px; height: 18px; flex-shrink: 0; opacity: 0.7; }
    .nav-item.active svg { opacity: 1; }
    .nav-badge {
      margin-left: auto;
      background: var(--red);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 1px 6px;
      border-radius: 8px;
      min-width: 18px;
      text-align: center;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid var(--border);
    }
    .device-info {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
    }
    .device-info-label { font-size: 10px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
    .device-info-value { font-family: var(--font-mono); font-size: 12px; color: var(--cyan); }
    .device-info-status { display: flex; align-items: center; gap: 6px; margin-top: 8px; font-size: 11px; }
    .device-info-dot { width: 7px; height: 7px; border-radius: 50%; }
    .device-info-dot.online { background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse-dot 2s infinite; }
    .device-info-dot.offline { background: var(--red); }

    /* Main */
    .main {
      flex: 1;
      margin-left: 220px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    /* Header */
    .header {
      height: 56px;
      background: var(--bg-header);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
    }
    .header-left { display: flex; align-items: center; gap: 16px; }
    .header-title { font-size: 17px; font-weight: 700; letter-spacing: -0.01em; }
    .header-right { display: flex; align-items: center; gap: 14px; }
    .mobile-menu-btn {
      display: none;
      background: none; border: none; color: var(--text-secondary); cursor: pointer;
      padding: 4px;
    }

    .demo-selector { position: relative; }
    .demo-btn {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 12.5px;
      font-weight: 500;
      font-family: var(--font-sans);
      transition: all 0.15s;
    }
    .demo-btn:hover { border-color: var(--border-light); background: var(--bg-card-hover); }
    .demo-icon {
      width: 22px; height: 22px;
      border-radius: 5px;
      display: flex; align-items: center; justify-content: center;
      font-size: 12px;
    }
    .demo-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      width: 260px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 16px 48px rgba(0,0,0,0.5);
      z-index: 200;
      overflow: hidden;
      display: none;
      animation: dropdown-in 0.15s ease-out;
    }
    .demo-dropdown.open { display: block; }
    .demo-option {
      width: 100%;
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px;
      border: none;
      background: transparent;
      color: var(--text-primary);
      cursor: pointer;
      text-align: left;
      font-family: var(--font-sans);
      transition: background 0.1s;
    }
    .demo-option:hover { background: rgba(255,255,255,0.04); }
    .demo-option.selected { background: var(--cyan-dim); }
    .demo-option-icon { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 15px; }
    .demo-option-text { flex: 1; }
    .demo-option-name { font-size: 13px; font-weight: 600; }
    .demo-option-sub { font-size: 11px; color: var(--text-muted); margin-top: 1px; }
    .demo-check { color: var(--green); font-size: 14px; }

    /* Status indicators */
    .conn-badge {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      font-family: var(--font-mono);
    }
    .conn-badge.connected { background: var(--green-dim); color: var(--green); }
    .conn-badge.disconnected { background: var(--red-dim); color: var(--red); }
    .conn-badge.simulated { background: var(--yellow-dim); color: var(--yellow); }
    .conn-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .conn-badge.connected .conn-dot { animation: pulse-dot 2s infinite; }

    .status-pill {
      display: flex; align-items: center; gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
    }
    .status-pill.running { background: var(--green-dim); color: var(--green); }
    .status-pill.stopped { background: var(--yellow-dim); color: var(--yellow); }

    .time-display {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-muted);
    }

    .power-btn {
      width: 32px; height: 32px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .power-btn.running { background: var(--red-dim); color: var(--red); border-color: rgba(248,113,113,0.2); }
    .power-btn.stopped { background: var(--green-dim); color: var(--green); border-color: rgba(74,222,128,0.2); }
    .power-btn:hover { filter: brightness(1.2); }

    /* Content area */
    .content {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    /* ============ CARDS ============ */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      transition: border-color 0.2s;
    }
    .card:hover { border-color: var(--border-light); }
    .card-lg { padding: 20px; }

    /* ============ GRID ============ */
    .grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 20px; }
    .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 20px; }
    .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 14px; }

    /* ============ KPI ============ */
    .kpi-label {
      font-size: 11px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .kpi-value {
      font-family: var(--font-mono);
      font-size: 26px;
      font-weight: 700;
      letter-spacing: -0.02em;
      line-height: 1;
    }
    .kpi-value.good { color: var(--green); }
    .kpi-unit { font-size: 13px; color: var(--text-muted); margin-left: 3px; font-weight: 500; }

    /* ============ SENSORS ============ */
    .sensor-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
    .sensor-name { font-size: 11px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.06em; font-weight: 600; }
    .sensor-type { font-size: 10px; color: var(--text-dim); margin-top: 2px; font-family: var(--font-mono); }
    .sensor-status { width: 8px; height: 8px; border-radius: 50%; }
    .sensor-status.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .sensor-status.warn { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); animation: pulse-dot 1s infinite; }

    .sensor-value {
      font-family: var(--font-mono);
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 10px;
      letter-spacing: -0.02em;
    }
    .sensor-unit { font-size: 15px; color: var(--text-muted); margin-left: 3px; font-weight: 500; }

    .sensor-bar {
      height: 6px;
      background: var(--border);
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .sensor-bar-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }
    .sensor-bar-fill::after {
      content: '';
      position: absolute;
      top: 0; right: 0; bottom: 0;
      width: 20px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2));
      border-radius: 0 3px 3px 0;
    }
    .sensor-range { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-dim); font-family: var(--font-mono); }

    /* ============ SECTION TITLE ============ */
    .section-title {
      font-size: 13px;
      font-weight: 700;
      margin-bottom: 14px;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    /* ============ ALARMS ============ */
    .alarm-row {
      display: flex; align-items: center; gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }
    .alarm-row:last-child { border-bottom: none; }
    .alarm-row:hover { background: rgba(255,255,255,0.02); }
    .alarm-row.acked { opacity: 0.4; }
    .alarm-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .alarm-dot.error { background: var(--red); box-shadow: 0 0 8px var(--red); animation: pulse-dot 1.2s infinite; }
    .alarm-dot.warning { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
    .alarm-dot.info { background: var(--blue); }
    .alarm-msg { flex: 1; font-size: 13px; color: var(--text-secondary); }
    .alarm-time { font-size: 11px; color: var(--text-dim); font-family: var(--font-mono); }
    .alarm-badge {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .alarm-badge.error { background: var(--red-dim); color: var(--red); }
    .alarm-badge.warning { background: var(--yellow-dim); color: var(--yellow); }
    .alarm-badge.info { background: var(--blue-dim); color: var(--blue); }
    .ack-btn {
      padding: 5px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      font-family: var(--font-sans);
      transition: all 0.15s;
    }
    .ack-btn:hover { background: var(--border); color: var(--text-primary); }

    /* ============ VISION ============ */
    .vision-panel {
      background: var(--bg-root);
      border-radius: var(--radius);
      padding: 24px;
      border: 1px solid var(--border);
    }
    .vision-title { font-size: 17px; font-weight: 700; text-align: center; margin-bottom: 4px; }
    .vision-sub { font-size: 12px; color: var(--text-muted); text-align: center; margin-bottom: 20px; font-family: var(--font-mono); }
    .vision-content { display: flex; gap: 28px; justify-content: center; align-items: flex-start; flex-wrap: wrap; }

    /* 7-segment */
    .seg-display {
      background: #000;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-sm);
      padding: 14px 20px;
      text-align: center;
    }
    .seg-label { font-size: 10px; color: var(--text-dim); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.08em; }
    .seg-value { font-family: var(--font-mono); font-size: 32px; font-weight: 700; color: var(--green); letter-spacing: 0.12em; }
    .seg-value.error { color: var(--red); animation: blink 0.6s infinite; }

    /* LEDs */
    .led-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
    .led-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .led { width: 16px; height: 16px; border-radius: 50%; border: 1px solid var(--border-light); transition: all 0.3s; }
    .led.on { box-shadow: 0 0 8px 3px currentColor; }
    .led.green { background: var(--green); color: var(--green); }
    .led.yellow { background: var(--yellow); color: var(--yellow); }
    .led.red { background: var(--red); color: var(--red); }
    .led.off { background: var(--border); }
    .led-label { font-size: 9px; color: var(--text-dim); font-family: var(--font-mono); font-weight: 600; }

    /* Stack light */
    .stack-light { display: flex; flex-direction: column; align-items: center; gap: 4px; }
    .stack-lamp { width: 30px; height: 30px; border-radius: 50%; border: 2px solid var(--border-light); transition: all 0.3s; }
    .stack-lamp.on.red { background: var(--red); border-color: #dc2626; box-shadow: 0 0 14px var(--red); }
    .stack-lamp.on.yellow { background: var(--yellow); border-color: #eab308; box-shadow: 0 0 14px var(--yellow); }
    .stack-lamp.on.green { background: var(--green); border-color: #22c55e; box-shadow: 0 0 14px var(--green); }
    .stack-lamp.off { background: var(--border); }

    /* I/O Panel */
    .io-panel { background: var(--bg-card); border-radius: var(--radius-sm); padding: 14px; }
    .io-title { font-size: 10px; color: var(--text-dim); text-align: center; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 0.08em; font-family: var(--font-mono); }
    .io-row { display: flex; gap: 8px; justify-content: center; }
    .io-bit { display: flex; flex-direction: column; align-items: center; }
    .io-led { width: 16px; height: 16px; border-radius: 3px; transition: all 0.3s; }
    .io-led.on.green { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .io-led.on.yellow { background: var(--yellow); box-shadow: 0 0 6px var(--yellow); }
    .io-led.off { background: var(--border); }
    .io-label { font-size: 9px; color: var(--text-dim); margin-top: 3px; font-family: var(--font-mono); }

    /* Progress */
    .progress { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .progress-fill { height: 100%; border-radius: 3px; transition: width 0.4s; }

    /* Gauge SVG */
    .gauge-container { text-align: center; }
    .gauge-label { font-size: 10px; color: var(--text-dim); margin-top: 6px; font-family: var(--font-mono); text-transform: uppercase; }

    /* Camera status */
    .camera-status {
      display: flex; align-items: center; gap: 10px;
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }
    .camera-status svg { color: var(--green); }

    /* ============ FORMS (Settings) ============ */
    .form-group { margin-bottom: 14px; }
    .form-label { display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 5px; font-weight: 600; }
    .form-input, .form-select {
      width: 100%;
      padding: 8px 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 13px;
      font-family: var(--font-sans);
      transition: border-color 0.15s;
    }
    .form-input:focus, .form-select:focus { outline: none; border-color: var(--cyan); box-shadow: 0 0 0 3px var(--cyan-dim); }
    .form-select option { background: var(--bg-card); }

    .sensor-config {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 14px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      margin-bottom: 8px;
      transition: border-color 0.15s;
    }
    .sensor-config:hover { border-color: var(--border-light); }
    .sensor-config-name { font-weight: 600; font-size: 13px; }
    .sensor-config-meta { font-size: 11px; color: var(--text-muted); font-family: var(--font-mono); margin-top: 2px; }

    /* ============ MQTT CONFIG PANEL ============ */
    .mqtt-panel {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      margin-bottom: 20px;
    }
    .mqtt-panel .section-title { margin-bottom: 16px; }
    .mqtt-status-bar {
      display: flex; align-items: center; gap: 12px;
      padding: 10px 14px;
      background: var(--bg-input);
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
    }
    .mqtt-status-text { font-size: 12px; color: var(--text-secondary); font-family: var(--font-mono); }
    .mqtt-connect-btn {
      margin-left: auto;
      padding: 6px 16px;
      background: var(--cyan);
      color: #000;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      font-family: var(--font-sans);
      transition: all 0.15s;
    }
    .mqtt-connect-btn:hover { filter: brightness(1.15); }
    .mqtt-connect-btn.disconnect { background: var(--red); color: #fff; }

    /* ============ SPARKLINE (mini chart) ============ */
    .sparkline-container {
      margin-top: 8px;
      height: 40px;
      position: relative;
      overflow: hidden;
    }
    .sparkline-svg { width: 100%; height: 100%; }

    /* ============ ANIMATIONS ============ */
    @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
    @keyframes dropdown-in { from { opacity: 0; transform: translateY(-4px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fade-in { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 4px currentColor; } 50% { box-shadow: 0 0 12px currentColor; } }

    .page-enter { animation: fade-in 0.2s ease-out; }

    /* ============ OVERLAY ============ */
    .overlay { position: fixed; inset: 0; z-index: 50; }
    .mobile-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5);
      z-index: 99; display: none;
    }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 1024px) {
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); }
      .sidebar.open { transform: translateX(0); }
      .mobile-overlay.show { display: block; }
      .main { margin-left: 0; }
      .mobile-menu-btn { display: flex; }
      .grid-4 { grid-template-columns: repeat(2, 1fr); }
      .grid-3 { grid-template-columns: 1fr; }
      .grid-2 { grid-template-columns: 1fr; }
      .content { padding: 16px; }
      .header { padding: 0 16px; }
      .vision-content { flex-direction: column; align-items: center; }
    }
    @media (max-width: 480px) {
      .grid-4 { grid-template-columns: 1fr; }
      .header-right .conn-badge span,
      .header-right .time-display { display: none; }
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Mobile Overlay -->
    <div class="mobile-overlay" id="mobile-overlay" onclick="closeMobileSidebar()"></div>

    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
      <div class="sidebar-brand">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 12C4 12 6 8 12 8C18 8 20 12 20 12"/>
          <path d="M6 12C6 12 8 10 12 10C16 10 18 12 18 12"/>
          <circle cx="12" cy="14" r="3" fill="currentColor"/>
          <path d="M12 17V21M9 19L12 22L15 19"/>
        </svg>
        <div class="sidebar-brand-text">
          <div class="sidebar-brand-name">Signal Tap</div>
          <div class="sidebar-brand-sub" id="sidebar-device-id">‚Äî</div>
        </div>
      </div>
      <div class="sidebar-nav" id="nav"></div>
      <div class="sidebar-footer">
        <div class="device-info">
          <div class="device-info-label">Device</div>
          <div class="device-info-value" id="footer-device-id">‚Äî</div>
          <div class="device-info-status">
            <div class="device-info-dot" id="footer-dot"></div>
            <span id="footer-status" style="color:var(--text-muted)">‚Äî</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Main -->
    <div class="main">
      <header class="header">
        <div class="header-left">
          <button class="mobile-menu-btn" onclick="openMobileSidebar()">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
          <h1 class="header-title" id="page-title">Home</h1>
          <div class="demo-selector">
            <button class="demo-btn" onclick="toggleDemoDropdown()">
              <div class="demo-icon" id="demo-icon"></div>
              <span id="demo-name">‚Äî</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="demo-dropdown" id="demo-dropdown"></div>
          </div>
        </div>
        <div class="header-right">
          <div class="conn-badge" id="conn-badge">
            <div class="conn-dot"></div>
            <span>‚Äî</span>
          </div>
          <div class="status-pill" id="status-pill">
            <div class="conn-dot"></div>
            <span>‚Äî</span>
          </div>
          <button class="power-btn" id="power-btn" onclick="toggleSystem()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18.36 6.64a9 9 0 1 1-12.73 0"/><line x1="12" y1="2" x2="12" y2="12"/></svg>
          </button>
          <div class="time-display" id="time-display">‚Äî</div>
        </div>
      </header>

      <div class="content" id="content"></div>
    </div>
  </div>

  <script>
    // ============================
    // DEVICE IDENTITY
    // ============================
    const urlParams = new URLSearchParams(window.location.search);
    const DEVICE_ID = urlParams.get('device') || urlParams.get('id') || 'SIGNALTAP-DEMO';
    const MQTT_TOPIC_PREFIX = `signaltap/${DEVICE_ID}`;

    // ============================
    // STATE
    // ============================
    let currentPage = 'home';
    let selectedDemo = 'cnc';
    let systemRunning = true;
    let demoDropdownOpen = false;
    let mqttClient = null;
    let mqttConnected = false;
    let useLiveData = false;

    // Scenario engine state (mirrors ESP32 simulation_engine)
    const SCENARIO_STATES = ['Normal', 'Degrading', 'Warning', 'FAULT', 'Recovering'];
    const SCENARIO_DURATIONS = [45, 20, 15, 12, 10]; // seconds per state
    const scenarioState = { cnc: 0, chiller: 0, compressor: 0, custom: 0 };
    const scenarioTimers = { cnc: 0, chiller: 0, compressor: 0, custom: 0 };
    const dynamicAlarms = { cnc: [], chiller: [], compressor: [], custom: [] };

    // MQTT configuration (user can change in settings)
    let mqttConfig = {
      broker: localStorage.getItem('mqtt_broker') || 'ws://broker.hivemq.com:8000/mqtt',
      username: localStorage.getItem('mqtt_user') || '',
      password: localStorage.getItem('mqtt_pass') || '',
    };

    // Sparkline history
    const sparklineHistory = {};

    // ============================
    // DEMO CONFIGURATIONS
    // ============================
    const DEMOS = {
      cnc: {
        name: 'CNC Machine Shop', sub: 'Siemens 810D Controller', color: '#3b82f6', icon: '‚öôÔ∏è',
        sensors: [
          { id: 1, name: 'Spindle Load', unit: '%', color: '#3b82f6', min: 0, max: 100, decimals: 1, type: 'CT Coil', value: 45 },
          { id: 2, name: 'Coolant Flow', unit: 'L/min', color: '#06b6d4', min: 0, max: 20, decimals: 1, type: 'Flow Sensor', value: 12 },
          { id: 3, name: 'Spindle Speed', unit: 'RPM', color: '#10b981', min: 0, max: 8000, decimals: 0, type: 'Encoder', value: 3500 },
        ],
        kpis: [{ label: 'OEE', value: '87.3', unit: '%' }, { label: 'Cycles', value: '142', unit: '' }, { label: 'Target', value: '160', unit: '' }, { label: 'Status', value: 'RUN', unit: '', good: true }],
        alarms: [
          { id: 1, sev: 'warning', msg: 'Spindle load above 80% threshold', time: '08:15:22', acked: false },
          { id: 2, sev: 'info', msg: 'Part count: 142 completed', time: '08:10:00', acked: true },
          { id: 3, sev: 'error', msg: 'Coolant level low ‚Äî refill required', time: '07:45:30', acked: false },
        ],
        vision: { type: 'cnc', partCount: 142, stackLight: 'green', leds: { PR: true, PS: false, PF: true, PF0: false, V5: true, NF: false, SF: true, CB: false } }
      },
      chiller: {
        name: 'Cold Storage Chiller', sub: 'Carrier 30RB Unit', color: '#06b6d4', icon: '‚ùÑÔ∏è',
        sensors: [
          { id: 1, name: 'Compressor Power', unit: 'kW', color: '#f59e0b', min: 0, max: 50, decimals: 1, type: 'CT 3-Phase', value: 28 },
          { id: 2, name: 'Supply Temp', unit: '¬∞C', color: '#06b6d4', min: -10, max: 20, decimals: 1, type: '4-20mA RTD', value: 2.5 },
          { id: 3, name: 'Return Temp', unit: '¬∞C', color: '#8b5cf6', min: -5, max: 25, decimals: 1, type: '4-20mA RTD', value: 8.2 },
        ],
        kpis: [{ label: 'ŒîT', value: '5.7', unit: '¬∞C' }, { label: 'Runtime', value: '1847', unit: 'hrs' }, { label: 'Energy', value: '892', unit: 'kWh' }, { label: 'Status', value: 'OK', unit: '', good: true }],
        alarms: [
          { id: 1, sev: 'error', msg: 'Error E07: High discharge pressure', time: '06:30:15', acked: false },
          { id: 2, sev: 'warning', msg: 'Compressor cycling frequency high', time: '06:15:00', acked: false },
          { id: 3, sev: 'info', msg: 'Runtime milestone: 1800 hours', time: '05:00:00', acked: true },
        ],
        vision: { type: 'chiller', errorCode: '---', compressorOn: true }
      },
      compressor: {
        name: 'Compressed Air System', sub: 'Atlas Copco GA30', color: '#10b981', icon: 'üí®',
        sensors: [
          { id: 1, name: 'Tank Pressure', unit: 'bar', color: '#10b981', min: 0, max: 12, decimals: 1, type: 'Analog Gauge CV', value: 8.2 },
          { id: 2, name: 'Oil Temperature', unit: '¬∞C', color: '#ef4444', min: 20, max: 120, decimals: 0, type: 'Analog Gauge CV', value: 75 },
          { id: 3, name: 'Motor Current', unit: 'A', color: '#f59e0b', min: 0, max: 60, decimals: 1, type: 'CT Coil', value: 32 },
        ],
        kpis: [{ label: 'Load', value: '72', unit: '%' }, { label: 'Cost/Day', value: '‚Ç¨48', unit: '' }, { label: 'Service', value: '342', unit: 'hrs' }, { label: 'State', value: 'LOAD', unit: '', good: true }],
        alarms: [
          { id: 1, sev: 'warning', msg: 'Oil temperature rising ‚Äî check cooling', time: '09:20:45', acked: false },
          { id: 2, sev: 'info', msg: 'Service reminder: 342 hours remaining', time: '09:00:00', acked: true },
        ],
        vision: { type: 'compressor', pressure: 8.2, oilTemp: 75, state: 'LOAD', leds: { power: true, load: true, ready: true, fault: false } }
      },
      custom: {
        name: 'Custom PLC Setup', sub: 'Siemens S7-1200', color: '#8b5cf6', icon: 'üîß',
        sensors: [
          { id: 1, name: 'Chamber Temperature', unit: '¬∞C', color: '#22d3ee', min: 20, max: 200, decimals: 1, type: 'RTD PT100', value: 85 },
          { id: 2, name: 'Chamber Pressure', unit: 'mbar', color: '#fb923c', min: 0, max: 1013, decimals: 0, type: '4-20mA', value: 450 },
          { id: 3, name: 'Compressor Pressure', unit: 'Bar', color: '#4ade80', min: 0, max: 10, decimals: 2, type: '0-10V', value: 4.5 },
        ],
        kpis: [{ label: 'Efficiency', value: '94.2', unit: '%' }, { label: 'Uptime', value: '99.1', unit: '%' }, { label: 'Cycles', value: '8472', unit: '' }, { label: 'Mode', value: 'AUTO', unit: '', good: true }],
        alarms: [
          { id: 1, sev: 'warning', msg: 'Chamber temp approaching limit', time: '07:32:15', acked: false },
          { id: 2, sev: 'info', msg: 'Scheduled maintenance in 5 days', time: '07:30:00', acked: true },
          { id: 3, sev: 'error', msg: 'Pressure spike detected', time: '07:28:45', acked: false },
        ],
        vision: { type: 'custom', diA: [1,0,1,1,0,0,1,0], dqA: [1,0,0,1,0,1,0,0], aq0: 65 }
      }
    };

    const NAV_ITEMS = [
      { id: 'home', label: 'Home', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>' },
      { id: 'sensors', label: 'Sensors', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="15" rx="2"/><path d="M16 7V4a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v3"/><line x1="12" y1="12" x2="12" y2="16"/></svg>' },
      { id: 'alarms', label: 'Alarms', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>' },
      { id: 'vision', label: 'Vision', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>' },
      { id: 'settings', label: 'Settings', icon: '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>' },
    ];

    // ============================
    // HELPERS
    // ============================
    function getDemo() { return DEMOS[selectedDemo]; }
    function pct(s) { return ((s.value - s.min) / (s.max - s.min)) * 100; }

    function pushSparkline(sensorKey, value) {
      if (!sparklineHistory[sensorKey]) sparklineHistory[sensorKey] = [];
      sparklineHistory[sensorKey].push(value);
      if (sparklineHistory[sensorKey].length > 30) sparklineHistory[sensorKey].shift();
    }

    function renderSparklineSVG(sensorKey, color) {
      const data = sparklineHistory[sensorKey] || [];
      if (data.length < 2) return '';
      const w = 200, h = 36;
      const min = Math.min(...data), max = Math.max(...data);
      const range = max - min || 1;
      const points = data.map((v, i) => {
        const x = (i / (data.length - 1)) * w;
        const y = h - ((v - min) / range) * (h - 4) - 2;
        return `${x},${y}`;
      }).join(' ');
      return `
        <div class="sparkline-container">
          <svg class="sparkline-svg" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none">
            <defs>
              <linearGradient id="sg-${sensorKey}" x1="0" y1="0" x2="0" y2="1">
                <stop offset="0%" stop-color="${color}" stop-opacity="0.3"/>
                <stop offset="100%" stop-color="${color}" stop-opacity="0"/>
              </linearGradient>
            </defs>
            <polygon points="0,${h} ${points} ${w},${h}" fill="url(#sg-${sensorKey})" />
            <polyline points="${points}" fill="none" stroke="${color}" stroke-width="1.5" stroke-linejoin="round"/>
          </svg>
        </div>
      `;
    }

    // ============================
    // MQTT
    // ============================
    function connectMQTT() {
      if (mqttClient) { mqttClient.end(true); }
      try {
        const opts = { clientId: `signaltap-web-${DEVICE_ID}-${Date.now()}`, clean: true, reconnectPeriod: 5000 };
        if (mqttConfig.username) { opts.username = mqttConfig.username; opts.password = mqttConfig.password; }
        mqttClient = mqtt.connect(mqttConfig.broker, opts);

        mqttClient.on('connect', () => {
          mqttConnected = true;
          useLiveData = true;
          mqttClient.subscribe(`${MQTT_TOPIC_PREFIX}/#`);
          updateConnectionUI();
        });

        mqttClient.on('message', (topic, message) => {
          handleMQTTMessage(topic, message.toString());
        });

        mqttClient.on('close', () => { mqttConnected = false; useLiveData = false; updateConnectionUI(); });
        mqttClient.on('error', () => { mqttConnected = false; useLiveData = false; updateConnectionUI(); });
      } catch (e) {
        console.warn('MQTT connection failed:', e);
        mqttConnected = false;
        useLiveData = false;
        updateConnectionUI();
      }
    }

    function disconnectMQTT() {
      if (mqttClient) { mqttClient.end(true); mqttClient = null; }
      mqttConnected = false;
      useLiveData = false;
      updateConnectionUI();
    }

    function handleMQTTMessage(topic, payload) {
      try {
        const data = JSON.parse(payload);
        const subTopic = topic.replace(`${MQTT_TOPIC_PREFIX}/`, '');

        if (subTopic === 'sensors') {
          // Update sensor values from device
          const demo = getDemo();
          if (data.sensors && Array.isArray(data.sensors)) {
            data.sensors.forEach((s, i) => {
              if (demo.sensors[i]) {
                demo.sensors[i].value = s.value;
              }
            });
          }
        } else if (subTopic === 'kpis') {
          const demo = getDemo();
          if (data.kpis) {
            data.kpis.forEach((k, i) => { if (demo.kpis[i]) { demo.kpis[i].value = k.value; } });
          }
        } else if (subTopic === 'alarms') {
          const demo = getDemo();
          if (data.alarms) demo.alarms = data.alarms;
        } else if (subTopic === 'vision') {
          const demo = getDemo();
          Object.assign(demo.vision, data);
        } else if (subTopic === 'status') {
          systemRunning = data.running;
          if (data.demo) selectedDemo = data.demo;
          updateSystemUI();
          updateDemoUI();
        }

        render();
      } catch (e) { /* ignore parse errors */ }
    }

    function updateConnectionUI() {
      const badge = document.getElementById('conn-badge');
      if (mqttConnected) {
        badge.className = 'conn-badge connected';
        badge.innerHTML = '<div class="conn-dot"></div><span>MQTT LIVE</span>';
      } else if (useLiveData === false && !mqttConnected) {
        badge.className = 'conn-badge simulated';
        badge.innerHTML = '<div class="conn-dot"></div><span>SIMULATED</span>';
      } else {
        badge.className = 'conn-badge disconnected';
        badge.innerHTML = '<div class="conn-dot"></div><span>OFFLINE</span>';
      }

      // Footer device info
      const dot = document.getElementById('footer-dot');
      const st = document.getElementById('footer-status');
      if (mqttConnected) {
        dot.className = 'device-info-dot online';
        st.textContent = 'Connected';
        st.style.color = 'var(--green)';
      } else {
        dot.className = 'device-info-dot offline';
        st.textContent = 'Simulated';
        st.style.color = 'var(--yellow)';
      }
    }

    // ============================
    // UI FUNCTIONS
    // ============================
    function openMobileSidebar() {
      document.getElementById('sidebar').classList.add('open');
      document.getElementById('mobile-overlay').classList.add('show');
    }
    function closeMobileSidebar() {
      document.getElementById('sidebar').classList.remove('open');
      document.getElementById('mobile-overlay').classList.remove('show');
    }

    function toggleDemoDropdown() {
      demoDropdownOpen = !demoDropdownOpen;
      document.getElementById('demo-dropdown').classList.toggle('open', demoDropdownOpen);
    }
    function closeDemoDropdown() {
      demoDropdownOpen = false;
      document.getElementById('demo-dropdown').classList.remove('open');
    }
    function selectDemo(id) {
      selectedDemo = id;
      closeDemoDropdown();
      updateDemoUI();
      render();
    }
    function toggleSystem() {
      systemRunning = !systemRunning;
      updateSystemUI();
    }
    function navigateTo(page) {
      currentPage = page;
      document.getElementById('page-title').textContent = page.charAt(0).toUpperCase() + page.slice(1);
      closeMobileSidebar();
      renderNav();
      render();
    }
    function ackAlarm(id) {
      const demo = getDemo();
      const alarm = demo.alarms.find(a => a.id === id);
      if (alarm) alarm.acked = true;
      render();
    }

    // ============================
    // RENDER: NAV
    // ============================
    function renderNav() {
      const demo = getDemo();
      const unacked = demo.alarms.filter(a => !a.acked).length;
      document.getElementById('nav').innerHTML = NAV_ITEMS.map(item => {
        const badge = item.id === 'alarms' && unacked > 0 ? `<span class="nav-badge">${unacked}</span>` : '';
        return `
          <div class="nav-item ${currentPage === item.id ? 'active' : ''}" onclick="navigateTo('${item.id}')">
            ${item.icon}
            <span>${item.label}</span>
            ${badge}
          </div>
        `;
      }).join('');
    }

    function updateDemoUI() {
      const demo = getDemo();
      document.getElementById('demo-icon').innerHTML = demo.icon;
      document.getElementById('demo-icon').style.background = demo.color + '20';
      document.getElementById('demo-name').textContent = demo.name;
      document.getElementById('demo-dropdown').innerHTML = Object.entries(DEMOS).map(([id, d]) => `
        <button class="demo-option ${id === selectedDemo ? 'selected' : ''}" onclick="selectDemo('${id}')">
          <div class="demo-option-icon" style="background:${d.color}20">${d.icon}</div>
          <div class="demo-option-text">
            <div class="demo-option-name">${d.name}</div>
            <div class="demo-option-sub">${d.sub}</div>
          </div>
          ${id === selectedDemo ? '<span class="demo-check">‚úì</span>' : ''}
        </button>
      `).join('');
    }

    function updateSystemUI() {
      const pill = document.getElementById('status-pill');
      const btn = document.getElementById('power-btn');
      pill.className = 'status-pill ' + (systemRunning ? 'running' : 'stopped');
      pill.innerHTML = `<div class="conn-dot"></div><span>${systemRunning ? 'RUNNING' : 'STOPPED'}</span>`;
      btn.className = 'power-btn ' + (systemRunning ? 'running' : 'stopped');
    }

    function updateTime() {
      document.getElementById('time-display').textContent = new Date().toLocaleTimeString();
    }

    // ============================
    // RENDER: PAGES
    // ============================
    function renderSensorCard(s, compact) {
      const p = pct(s);
      const warn = p > 80 || p < 10;
      const key = `${selectedDemo}-${s.id}`;
      pushSparkline(key, s.value);
      return `
        <div class="card">
          <div class="sensor-header">
            <div>
              <div class="sensor-name">${s.name}</div>
              <div class="sensor-type">${s.type}</div>
            </div>
            <div class="sensor-status ${warn ? 'warn' : 'ok'}"></div>
          </div>
          <div class="sensor-value" style="color:${s.color}">${s.value.toFixed(s.decimals)}<span class="sensor-unit">${s.unit}</span></div>
          <div class="sensor-bar"><div class="sensor-bar-fill" style="width:${Math.min(100,p)}%;background:${s.color}"></div></div>
          <div class="sensor-range"><span>${s.min}</span><span>${s.max} ${s.unit}</span></div>
          ${compact ? '' : renderSparklineSVG(key, s.color)}
        </div>
      `;
    }

    function renderHome() {
      const demo = getDemo();
      const si = scenarioState[selectedDemo];
      const scenName = SCENARIO_STATES[si];
      const scenColor = si === 0 ? 'var(--green)' : si === 3 ? 'var(--red)' : si === 4 ? 'var(--blue)' : 'var(--yellow)';
      const dynAlarms = dynamicAlarms[selectedDemo].filter(a => a.active).reverse().slice(0, 4);
      return `
        <div class="page-enter">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div class="grid-4" style="flex:1">
              ${demo.kpis.map(k => `
                <div class="card">
                  <div class="kpi-label">${k.label}</div>
                  <div class="kpi-value ${k.good ? 'good' : ''}">${k.value}<span class="kpi-unit">${k.unit}</span></div>
                </div>
              `).join('')}
            </div>
            <div class="card" style="width:110px;text-align:center;margin-left:10px;padding:10px">
              <div class="kpi-label">Scenario</div>
              <div style="color:${scenColor};font-weight:700;font-size:15px">${scenName}</div>
            </div>
          </div>
          <div class="section-title">Live Sensors</div>
          <div class="grid-3">
            ${demo.sensors.map(s => renderSensorCard(s, true)).join('')}
          </div>
          <div class="section-title">Live Alarms (${dynAlarms.length})</div>
          <div class="card" style="padding:0;overflow:hidden">
            ${dynAlarms.length === 0 ? '<div style="padding:16px;text-align:center;color:var(--green);font-size:14px">No active alarms</div>' :
            dynAlarms.map(a => `
              <div class="alarm-row ${a.acked ? 'acked' : ''}">
                <div class="alarm-dot ${a.sev}"></div>
                <div class="alarm-msg">${a.msg}</div>
                <div class="alarm-time">${a.time}</div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function renderSensors() {
      const demo = getDemo();
      return `<div class="page-enter">` + demo.sensors.map(s => {
        const p = pct(s);
        const key = `${selectedDemo}-${s.id}`;
        return `
          <div class="card card-lg" style="margin-bottom:16px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <div>
                <div style="font-size:18px;font-weight:700">${s.name}</div>
                <div style="font-size:13px;color:var(--text-muted);font-family:var(--font-mono)">${s.type}</div>
              </div>
              <div class="sensor-value" style="color:${s.color};margin:0">${s.value.toFixed(s.decimals)}<span class="sensor-unit">${s.unit}</span></div>
            </div>
            <div class="sensor-bar" style="height:10px;margin-bottom:8px"><div class="sensor-bar-fill" style="width:${Math.min(100,p)}%;background:${s.color}"></div></div>
            <div class="sensor-range"><span>Min: ${s.min} ${s.unit}</span><span>Max: ${s.max} ${s.unit}</span></div>
            ${renderSparklineSVG(key, s.color)}
          </div>
        `;
      }).join('') + '</div>';
    }

    function renderAlarms() {
      const demo = getDemo();
      const dynAlarms = dynamicAlarms[selectedDemo].filter(a => a.active);
      const allAlarms = [...dynAlarms].reverse(); // Most recent first
      const unacked = allAlarms.filter(a => !a.acked).length;
      const si = scenarioState[selectedDemo];
      const scenName = SCENARIO_STATES[si];
      const scenColor = si === 0 ? 'var(--green)' : si === 3 ? 'var(--red)' : si === 4 ? 'var(--blue)' : 'var(--yellow)';
      return `
        <div class="page-enter">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <div style="color:var(--text-secondary);font-size:14px">${allAlarms.length} active alarm${allAlarms.length !== 1 ? 's' : ''} (${unacked} unacknowledged)</div>
            <div style="padding:4px 12px;border-radius:4px;font-size:13px;font-weight:600;color:${scenColor};background:${scenColor}22">System: ${scenName}</div>
          </div>
          <div class="card" style="padding:0;overflow:hidden">
            ${allAlarms.length === 0 ? '<div style="padding:24px;text-align:center;color:var(--green)">No active alarms ‚Äî system operating normally</div>' :
            allAlarms.map((a, i) => `
              <div class="alarm-row ${a.acked ? 'acked' : ''}">
                <div class="alarm-dot ${a.sev}"></div>
                <div style="flex:1">
                  <div class="alarm-msg" style="margin-bottom:4px">${a.msg}</div>
                  <div class="alarm-time">${a.time}</div>
                </div>
                <span class="alarm-badge ${a.sev}">${a.sev.toUpperCase()}</span>
                ${!a.acked ? `<button class="ack-btn" onclick="ackDynAlarm('${selectedDemo}',${i})">ACK</button>` : ''}
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function ackDynAlarm(demoKey, idx) {
      const active = dynamicAlarms[demoKey].filter(a => a.active).reverse();
      if (active[idx]) active[idx].acked = true;
      render();
    }

    function renderVision() {
      const demo = getDemo();
      const v = demo.vision;
      let content = '';

      if (v.type === 'cnc') {
        content = `
          <div class="seg-display">
            <div class="seg-label">Part Counter</div>
            <div class="seg-value">${String(v.partCount).padStart(4, '0')}</div>
          </div>
          <div class="led-grid">
            ${Object.entries(v.leds).map(([k, on]) => `
              <div class="led-item">
                <div class="led ${on ? 'on green' : 'off'}"></div>
                <div class="led-label">${k}</div>
              </div>
            `).join('')}
          </div>
          <div>
            <div class="led-label" style="text-align:center;margin-bottom:10px">STACK</div>
            <div class="stack-light">
              <div class="stack-lamp ${v.stackLight === 'red' ? 'on red' : 'off'}"></div>
              <div class="stack-lamp ${v.stackLight === 'yellow' ? 'on yellow' : 'off'}"></div>
              <div class="stack-lamp ${v.stackLight === 'green' ? 'on green' : 'off'}"></div>
            </div>
          </div>
        `;
      } else if (v.type === 'chiller') {
        content = `
          <div class="seg-display">
            <div class="seg-label">Error Code</div>
            <div class="seg-value ${v.errorCode !== '---' ? 'error' : ''}">${v.errorCode}</div>
          </div>
          <div style="text-align:center">
            <div class="led ${v.compressorOn ? 'on green' : 'off'}" style="width:28px;height:28px;margin:0 auto"></div>
            <div class="led-label" style="margin-top:8px">Compressor</div>
          </div>
          <div class="grid-2" style="gap:16px">
            <div class="io-panel">
              <div style="font-size:11px;color:var(--text-dim)">Supply</div>
              <div style="font-size:22px;font-weight:700;color:#06b6d4;font-family:var(--font-mono)">2.5¬∞C</div>
            </div>
            <div class="io-panel">
              <div style="font-size:11px;color:var(--text-dim)">Return</div>
              <div style="font-size:22px;font-weight:700;color:#8b5cf6;font-family:var(--font-mono)">8.2¬∞C</div>
            </div>
          </div>
        `;
      } else if (v.type === 'compressor') {
        content = `
          <div class="gauge-container">
            <svg viewBox="0 0 100 60" width="140" height="88">
              <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#2a2d35" stroke-width="8" stroke-linecap="round"/>
              <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#10b981" stroke-width="6" stroke-linecap="round" stroke-dasharray="126" stroke-dashoffset="${126 - (v.pressure / 12) * 126}"/>
              <circle cx="50" cy="52" r="4" fill="#f1f5f9"/>
              <text x="50" y="42" text-anchor="middle" fill="#10b981" font-size="12" font-weight="bold" font-family="JetBrains Mono">${v.pressure.toFixed(1)}</text>
            </svg>
            <div class="gauge-label">Pressure (bar)</div>
          </div>
          <div class="gauge-container">
            <svg viewBox="0 0 100 60" width="140" height="88">
              <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#2a2d35" stroke-width="8" stroke-linecap="round"/>
              <path d="M 10 55 A 40 40 0 0 1 90 55" fill="none" stroke="#ef4444" stroke-width="6" stroke-linecap="round" stroke-dasharray="126" stroke-dashoffset="${126 - ((v.oilTemp - 20) / 100) * 126}"/>
              <circle cx="50" cy="52" r="4" fill="#f1f5f9"/>
              <text x="50" y="42" text-anchor="middle" fill="#ef4444" font-size="12" font-weight="bold" font-family="JetBrains Mono">${v.oilTemp.toFixed(0)}</text>
            </svg>
            <div class="gauge-label">Oil Temp (¬∞C)</div>
          </div>
          <div class="led-grid" style="grid-template-columns:repeat(2,1fr)">
            ${Object.entries(v.leds).map(([k, on]) => `
              <div class="led-item" style="flex-direction:row;gap:10px">
                <div class="led ${on ? (k === 'fault' ? 'on red' : 'on green') : 'off'}" style="width:14px;height:14px"></div>
                <div class="led-label" style="margin:0;text-transform:capitalize">${k}</div>
              </div>
            `).join('')}
          </div>
          <div class="seg-display" style="padding:10px 20px">
            <div class="seg-value" style="font-size:22px;color:${v.state === 'LOAD' ? '#4ade80' : '#facc15'}">${v.state}</div>
          </div>
        `;
      } else if (v.type === 'custom') {
        content = `
          <div class="io-panel">
            <div class="io-title">DI a (.0-.7)</div>
            <div class="io-row">
              ${v.diA.map((on, i) => `
                <div class="io-bit">
                  <div class="io-led ${on ? 'on green' : 'off'}"></div>
                  <div class="io-label">.${i}</div>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="io-panel">
            <div class="io-title">DQ a (.0-.7)</div>
            <div class="io-row">
              ${v.dqA.map((on, i) => `
                <div class="io-bit">
                  <div class="io-led ${on ? 'on yellow' : 'off'}"></div>
                  <div class="io-label">.${i}</div>
                </div>
              `).join('')}
            </div>
          </div>
          <div class="io-panel" style="min-width:110px">
            <div class="io-title">AQ 0</div>
            <div style="font-size:28px;font-weight:700;color:var(--cyan);text-align:center;font-family:var(--font-mono)">${v.aq0.toFixed(0)}%</div>
            <div class="progress" style="margin-top:10px"><div class="progress-fill" style="width:${v.aq0}%;background:var(--cyan)"></div></div>
          </div>
        `;
      }

      return `
        <div class="page-enter">
          <div class="vision-panel">
            <div class="vision-title">${demo.name}</div>
            <div class="vision-sub">${demo.sub}</div>
            <div class="vision-content">${content}</div>
          </div>
          <div class="card" style="margin-top:20px">
            <div class="camera-status">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
              Camera stream active ¬∑ 30 FPS ¬∑ CV processing enabled
            </div>
          </div>
        </div>
      `;
    }

    function renderSettings() {
      const demo = getDemo();
      return `
        <div class="page-enter">
          <!-- MQTT Configuration -->
          <div class="mqtt-panel">
            <div class="section-title">MQTT Connection</div>
            <div class="mqtt-status-bar">
              <div class="conn-dot" style="width:8px;height:8px;border-radius:50%;background:${mqttConnected ? 'var(--green)' : 'var(--red)'}"></div>
              <span class="mqtt-status-text">${mqttConnected ? 'Connected to ' + mqttConfig.broker : 'Disconnected'}</span>
              <button class="mqtt-connect-btn ${mqttConnected ? 'disconnect' : ''}" onclick="${mqttConnected ? 'disconnectMQTT()' : 'saveMQTTAndConnect()'}">
                ${mqttConnected ? 'Disconnect' : 'Connect'}
              </button>
            </div>
            <div class="grid-2" style="margin-bottom:0">
              <div class="form-group">
                <label class="form-label">Broker URL (WebSocket)</label>
                <input type="text" class="form-input" id="mqtt-broker-input" value="${mqttConfig.broker}" placeholder="ws://broker.hivemq.com:8000/mqtt">
              </div>
              <div class="form-group">
                <label class="form-label">Topic Prefix</label>
                <input type="text" class="form-input" value="${MQTT_TOPIC_PREFIX}" readonly style="opacity:0.6">
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label class="form-label">Username (optional)</label>
                <input type="text" class="form-input" id="mqtt-user-input" value="${mqttConfig.username}" placeholder="‚Äî">
              </div>
              <div class="form-group" style="margin-bottom:0">
                <label class="form-label">Password (optional)</label>
                <input type="password" class="form-input" id="mqtt-pass-input" value="${mqttConfig.password}" placeholder="‚Äî">
              </div>
            </div>
          </div>

          <!-- Device Configuration -->
          <div class="card card-lg" style="margin-bottom:20px">
            <div class="section-title">Device Configuration</div>
            <div class="grid-2">
              <div class="form-group">
                <label class="form-label">Device ID</label>
                <input type="text" class="form-input" value="${DEVICE_ID}" readonly style="opacity:0.6">
              </div>
              <div class="form-group">
                <label class="form-label">Active Demo Profile</label>
                <select class="form-select" onchange="selectDemo(this.value)">
                  ${Object.entries(DEMOS).map(([id, d]) => `<option value="${id}" ${id === selectedDemo ? 'selected' : ''}>${d.name}</option>`).join('')}
                </select>
              </div>
            </div>
            <div class="form-group" style="margin-bottom:0">
              <label class="form-label">Dashboard URL</label>
              <input type="text" class="form-input" value="${window.location.href}" readonly style="opacity:0.6;font-family:var(--font-mono);font-size:11px">
            </div>
          </div>

          <!-- Sensor Configuration -->
          <div class="card card-lg">
            <div class="section-title">Sensor Configuration ‚Äî ${demo.name}</div>
            ${demo.sensors.map(s => `
              <div class="sensor-config">
                <div>
                  <div class="sensor-config-name">${s.name}</div>
                  <div class="sensor-config-meta">${s.type} ¬∑ ${s.min}‚Äì${s.max} ${s.unit}</div>
                </div>
                <div class="sensor-status ok"></div>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    function saveMQTTAndConnect() {
      mqttConfig.broker = document.getElementById('mqtt-broker-input').value;
      mqttConfig.username = document.getElementById('mqtt-user-input').value;
      mqttConfig.password = document.getElementById('mqtt-pass-input').value;
      localStorage.setItem('mqtt_broker', mqttConfig.broker);
      localStorage.setItem('mqtt_user', mqttConfig.username);
      localStorage.setItem('mqtt_pass', mqttConfig.password);
      connectMQTT();
    }

    // ============================
    // RENDER MAIN
    // ============================
    function render() {
      const content = document.getElementById('content');
      switch (currentPage) {
        case 'home': content.innerHTML = renderHome(); break;
        case 'sensors': content.innerHTML = renderSensors(); break;
        case 'alarms': content.innerHTML = renderAlarms(); break;
        case 'vision': content.innerHTML = renderVision(); break;
        case 'settings': content.innerHTML = renderSettings(); break;
      }
    }

    // ============================
    // SIMULATION ENGINE (scenario-driven, physics-correlated)
    // ============================
    function approach(current, target, rate) { return current + (target - current) * rate; }
    function noise(amp) { return (Math.random() - 0.5) * 2 * amp; }
    function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }
    function timeStr() { const d = new Date(); return `${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}:${String(d.getSeconds()).padStart(2,'0')}`; }

    function addDynAlarm(key, sev, msg) {
      const arr = dynamicAlarms[key];
      if (arr.find(a => a.active && a.msg === msg)) return;
      if (arr.length >= 8) arr.shift();
      arr.push({ sev, msg, time: timeStr(), acked: false, active: true });
    }

    function simulate() {
      if (!systemRunning || mqttConnected) return;

      Object.entries(DEMOS).forEach(([key, demo]) => {
        scenarioTimers[key]++;
        const si = scenarioState[key];
        const progress = scenarioTimers[key] / SCENARIO_DURATIONS[si];

        // State transition
        if (scenarioTimers[key] >= SCENARIO_DURATIONS[si]) {
          scenarioState[key] = (si + 1) % 5;
          scenarioTimers[key] = 0;
          if (scenarioState[key] === 4) dynamicAlarms[key].forEach(a => { if (a.sev === 'error') a.active = false; });
        }

        let targets = [0, 0, 0];
        const s = demo.sensors;

        // Physics models per demo
        if (key === 'cnc') {
          switch (si) {
            case 0: targets = [55+noise(3), 13+noise(0.5), 4500+noise(100)]; demo.vision.stackLight='green'; demo.vision.leds.NF=false; demo.vision.leds.SF=false; if(Math.random()>0.92) demo.vision.partCount++; break;
            case 1: targets = [55+progress*25+noise(2), 13-progress*4+noise(0.3), 4500-progress*500+noise(80)]; if(progress>0.5) demo.vision.stackLight='yellow'; if(progress>0.3) addDynAlarm(key,'info','Spindle load trending upward'); if(progress>0.7) addDynAlarm(key,'warning','Coolant flow below optimal'); break;
            case 2: targets = [82+progress*8+noise(2), 8.5-progress*2+noise(0.3), 3800-progress*400+noise(60)]; demo.vision.stackLight='yellow'; addDynAlarm(key,'warning','Spindle load above 80%'); if(progress>0.6) addDynAlarm(key,'error','Coolant critically low'); break;
            case 3: targets = [95+noise(3), 4+noise(0.5), 1000*(1-progress)+noise(50)]; demo.vision.stackLight='red'; demo.vision.leds.NF=true; demo.vision.leds.SF=true; addDynAlarm(key,'error','FAULT: Spindle overload tripped'); break;
            case 4: targets = [90-progress*35+noise(2), 5+progress*8+noise(0.3), 500+progress*4000+noise(100)]; if(progress>0.3) demo.vision.stackLight='green'; if(progress>0.5){demo.vision.leds.NF=false;demo.vision.leds.SF=false;} addDynAlarm(key,'info','System recovery in progress'); break;
          }
        } else if (key === 'chiller') {
          switch (si) {
            case 0: targets = [26+noise(1), 2+noise(0.3), 7.5+noise(0.3)]; demo.vision.errorCode='---'; demo.kpis[3].value='OK'; demo.kpis[3].good=true; break;
            case 1: targets = [26+progress*10+noise(0.8), 2+progress*3+noise(0.2), 7.5+progress*2+noise(0.2)]; if(progress>0.4) addDynAlarm(key,'warning','Supply temp rising'); break;
            case 2: targets = [38+progress*8+noise(1.5), 5.5+progress*3+noise(0.4), 10+progress*3+noise(0.3)]; addDynAlarm(key,'warning','High discharge pressure'); if(progress>0.5) demo.vision.errorCode='E07'; demo.kpis[3].value='WARN'; demo.kpis[3].good=false; break;
            case 3: targets = [8+noise(2), 9+progress*6+noise(0.5), 14+progress*5+noise(0.4)]; demo.vision.errorCode='E07'; demo.kpis[3].value='FAULT'; demo.kpis[3].good=false; addDynAlarm(key,'error','E07: Compressor tripped'); break;
            case 4: targets = [12+progress*16+noise(1), 14-progress*12+noise(0.3), 18-progress*10.5+noise(0.3)]; if(progress>0.3) demo.vision.errorCode='---'; if(progress>0.6){demo.kpis[3].value='OK';demo.kpis[3].good=true;} addDynAlarm(key,'info','Chiller recovery'); break;
          }
        } else if (key === 'compressor') {
          switch (si) {
            case 0: targets = [8+noise(0.3), 75+noise(2), 32+noise(1.5)]; demo.vision.state='LOAD'; demo.vision.pressure=targets[0]; demo.vision.oilTemp=targets[1]; break;
            case 1: targets = [8-progress*1.5+noise(0.2), 75+progress*18+noise(1.5), 32+progress*8+noise(1)]; demo.vision.pressure=targets[0]; demo.vision.oilTemp=targets[1]; if(progress>0.5) addDynAlarm(key,'warning','Oil temp trending high'); break;
            case 2: targets = [6.2-progress*1.2+noise(0.3), 95+progress*15+noise(2), 42+progress*10+noise(1.5)]; demo.vision.pressure=targets[0]; demo.vision.oilTemp=targets[1]; addDynAlarm(key,'warning','Oil temp approaching limit'); if(progress>0.5) addDynAlarm(key,'error','Tank pressure critically low'); break;
            case 3: targets = [4.5-progress*2.5+noise(0.2), 112+noise(1), 5*(1-progress)+noise(0.5)]; demo.vision.state='FAULT'; demo.vision.pressure=targets[0]; demo.vision.oilTemp=targets[1]; demo.kpis[3].value='FAULT'; demo.kpis[3].good=false; addDynAlarm(key,'error','THERMAL SHUTDOWN'); break;
            case 4: targets = [2.5+progress*5.5+noise(0.2), 110-progress*35+noise(1), 5+progress*27+noise(1)]; if(progress>0.4){demo.vision.state='LOAD';demo.kpis[3].value='LOAD';demo.kpis[3].good=true;}else demo.vision.state='IDLE'; demo.vision.pressure=targets[0]; demo.vision.oilTemp=targets[1]; addDynAlarm(key,'info','Compressor cooling down'); break;
          }
        } else if (key === 'custom') {
          switch (si) {
            case 0: targets = [85+noise(1.5), 500+noise(15), 5+noise(0.2)]; demo.vision.aq0=65+noise(3); demo.kpis[3].value='AUTO'; demo.kpis[3].good=true; break;
            case 1: targets = [85+progress*30+noise(2), 500+progress*150+noise(10), 5-progress*0.8+noise(0.15)]; demo.vision.aq0=65+progress*20; if(progress>0.5) addDynAlarm(key,'warning','Chamber temp drifting'); break;
            case 2: targets = [120+progress*40+noise(3), 660+progress*200+noise(20), 4-progress+noise(0.2)]; demo.vision.aq0=Math.min(100,90+progress*10); addDynAlarm(key,'warning','Chamber temp approaching limit'); if(progress>0.7) addDynAlarm(key,'error','Pressure spike detected'); break;
            case 3: targets = [165+noise(2), 850+noise(30), 2+noise(0.3)]; demo.vision.aq0=0; demo.vision.dqA=[0,0,0,0,0,0,0,0]; demo.kpis[3].value='STOP'; demo.kpis[3].good=false; addDynAlarm(key,'error','SAFETY SHUTDOWN: Overtemperature'); break;
            case 4: targets = [160-progress*75+noise(2), 850-progress*350+noise(15), 2.5+progress*2.5+noise(0.15)]; if(progress>0.4){demo.vision.dqA=[1,0,0,1,0,1,0,0];demo.vision.aq0=progress*65;} if(progress>0.7){demo.kpis[3].value='AUTO';demo.kpis[3].good=true;} addDynAlarm(key,'info','Process restarting'); break;
          }
        }

        // Smooth sensor values toward targets
        for (let i = 0; i < 3; i++) {
          s[i].value = clamp(approach(s[i].value, clamp(targets[i], s[i].min, s[i].max), 0.15), s[i].min, s[i].max);
        }
      });

      render();
    }

    // ============================
    // INIT
    // ============================
    document.addEventListener('click', e => {
      if (!e.target.closest('.demo-selector')) closeDemoDropdown();
    });

    // Set device ID in UI
    document.getElementById('sidebar-device-id').textContent = DEVICE_ID;
    document.getElementById('footer-device-id').textContent = DEVICE_ID;
    document.title = `Signal Tap ‚Äî ${DEVICE_ID}`;

    renderNav();
    updateDemoUI();
    updateSystemUI();
    updateConnectionUI();
    updateTime();
    render();

    setInterval(updateTime, 1000);
    setInterval(simulate, 1000);

    // Auto-connect MQTT on load if broker is configured
    // (Uncomment the line below to auto-connect)
    // connectMQTT();
  </script>
</body>
</html>
